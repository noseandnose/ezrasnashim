<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reset Password - Ezras Nashim</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#faf8f9;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{width:100%;max-width:400px;background:#fff;border-radius:20px;padding:32px 24px;box-shadow:0 4px 24px rgba(0,0,0,0.08)}
h1{text-align:center;font-size:24px;color:#000;margin-bottom:6px}
.subtitle{text-align:center;color:#666;font-size:14px;margin-bottom:28px}
.field{margin-bottom:18px;position:relative}
label{display:block;font-size:13px;font-weight:600;color:#333;margin-bottom:6px}
input{width:100%;padding:12px 14px;border:1.5px solid #e0d8dc;border-radius:12px;font-size:16px;outline:none;transition:border-color .2s}
input:focus{border-color:#D5CDE4}
input.pw-input{padding-right:44px}
.toggle{position:absolute;right:12px;top:34px;background:none;border:none;color:#999;cursor:pointer;font-size:13px;padding:4px}
.toggle:hover{color:#666}
.field-error{color:#e53e3e;font-size:13px;margin-top:6px;display:none}
.field-error.show{display:block}
.msg{text-align:center;padding:16px;border-radius:12px;margin-bottom:16px;font-size:14px;display:none}
.msg.error-msg{background:#fee;color:#c53030;display:block}
.msg.success-msg{background:#f0fff4;color:#276749;display:block}
.msg.info-msg{background:#ebf8ff;color:#2b6cb0;display:block}
.btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;color:#fff;cursor:pointer;background:linear-gradient(135deg,#EAC8CD 0%,#D5CDE4 50%,#B3CCB3 100%);transition:opacity .2s,transform .2s}
.btn:hover{opacity:0.9}
.btn:active{transform:scale(0.98)}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.link-btn{background:none;border:none;color:#D5CDE4;cursor:pointer;font-size:13px;text-align:center;width:100%;margin-top:12px;padding:4px}
.link-btn:hover{color:#b3a5c7;text-decoration:underline}
.code-input{text-align:center;font-size:24px;letter-spacing:8px;font-weight:700;padding:16px}
.spinner{display:none;text-align:center;padding:32px 0}
.spinner.show{display:block}
.spinner-ring{display:inline-block;width:36px;height:36px;border:3px solid #e0d8dc;border-top-color:#D5CDE4;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner p{color:#666;font-size:13px;margin-top:12px}
.back{display:block;text-align:center;margin-top:18px;color:#D5CDE4;text-decoration:none;font-size:14px;font-weight:500}
.back:hover{color:#b3a5c7}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="container">
<h1>Ezras Nashim</h1>
<p class="subtitle" id="subtitle">Reset your password</p>
<div id="msg" class="msg"></div>

<div id="loading" class="spinner show">
<div class="spinner-ring"></div>
<p>Loading...</p>
</div>

<form id="email-form" class="hidden">
<div class="field">
<label for="email">Email Address</label>
<input type="email" id="email" placeholder="Enter your email" autocomplete="email" required>
<div class="field-error" id="email-err"></div>
</div>
<button type="submit" class="btn" id="email-btn">Send Reset Code</button>
</form>

<form id="code-form" class="hidden">
<p style="text-align:center;color:#666;font-size:13px;margin-bottom:16px">We sent a 6-digit code to <strong id="sent-email"></strong></p>
<div class="field">
<label for="code">Reset Code</label>
<input type="text" id="code" class="code-input" placeholder="000000" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code">
<div class="field-error" id="code-err"></div>
</div>
<div class="field">
<label for="code-pw">New Password</label>
<input type="password" id="code-pw" class="pw-input" placeholder="Enter new password" autocomplete="new-password">
<button type="button" class="toggle" onclick="togglePw('code-pw',this)">Show</button>
<div class="field-error" id="code-pw-err"></div>
</div>
<div class="field">
<label for="code-cpw">Confirm Password</label>
<input type="password" id="code-cpw" class="pw-input" placeholder="Confirm new password" autocomplete="new-password">
<button type="button" class="toggle" onclick="togglePw('code-cpw',this)">Show</button>
<div class="field-error" id="code-cpw-err"></div>
</div>
<button type="submit" class="btn" id="code-btn">Reset Password</button>
<button type="button" class="link-btn" id="resend-btn">Didn't receive it? Send again</button>
</form>

<form id="pw-form" class="hidden">
<div class="field">
<label for="pw">New Password</label>
<input type="password" id="pw" class="pw-input" placeholder="Enter new password" autocomplete="new-password">
<button type="button" class="toggle" onclick="togglePw('pw',this)">Show</button>
<div class="field-error" id="pw-err"></div>
</div>
<div class="field">
<label for="cpw">Confirm Password</label>
<input type="password" id="cpw" class="pw-input" placeholder="Confirm new password" autocomplete="new-password">
<button type="button" class="toggle" onclick="togglePw('cpw',this)">Show</button>
<div class="field-error" id="cpw-err"></div>
</div>
<button type="submit" class="btn" id="pw-btn">Update Password</button>
</form>

<a class="back" href="/">Back to App</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const $=id=>document.getElementById(id);
let sb=null;
let userEmail='';

function togglePw(id,el){const i=$(id);if(i.type==='password'){i.type='text';el.textContent='Hide'}else{i.type='password';el.textContent='Show'}}
function showMsg(text,type){const m=$('msg');m.className='msg '+type+'-msg';m.textContent=text}
function clearMsg(){$('msg').className='msg'}
function hideAll(){['loading','email-form','code-form','pw-form'].forEach(id=>$(id).classList.add('hidden'))}
function showSection(id){hideAll();$(id).classList.remove('hidden')}
function showErr(id,text){$(id).textContent=text;$(id).classList.add('show')}
function clearErrs(){for(var i=0;i<arguments.length;i++){$(arguments[i]).classList.remove('show')}}

async function init(){
try{
var r=await fetch('/api/auth/public-config');
var cfg=await r.json();
sb=supabase.createClient(cfg.url,cfg.anonKey);
}catch(e){
showSection('email-form');
showMsg('Unable to connect. Please try again later.','error');
return;
}

var hash=window.location.hash.substring(1);
var hashParams=new URLSearchParams(hash);
var queryParams=new URLSearchParams(window.location.search);
var hasTokens=hash&&(hashParams.get('access_token')||hashParams.get('error')||hashParams.get('type'));
var hasCode=queryParams.get('code');

if(!hasTokens&&!hasCode){
showSection('email-form');
return;
}

showSection('loading');
$('loading').querySelector('p').textContent='Verifying your reset link...';

var errCode=hashParams.get('error')||queryParams.get('error');
if(errCode){
showSection('email-form');
showMsg('Your reset link has expired. Enter your email below to get a new reset code.','info');
return;
}

if(hasCode){
try{
var res=await sb.auth.exchangeCodeForSession(hasCode);
if(res.error)throw res.error;
$('subtitle').textContent='Set your new password';
showSection('pw-form');
return;
}catch(e){
showSection('email-form');
showMsg('This reset link has expired. Enter your email below to get a new reset code.','info');
return;
}
}

var access_token=hashParams.get('access_token');
var refresh_token=hashParams.get('refresh_token');
if(access_token&&refresh_token){
try{
var res2=await sb.auth.setSession({access_token:access_token,refresh_token:refresh_token});
if(res2.error)throw res2.error;
$('subtitle').textContent='Set your new password';
showSection('pw-form');
return;
}catch(e){
showSection('email-form');
showMsg('This reset link has expired. Enter your email below to get a new reset code.','info');
return;
}
}

var ready=false;
sb.auth.onAuthStateChange(function(event){
if(event==='PASSWORD_RECOVERY'&&!ready){
ready=true;
$('subtitle').textContent='Set your new password';
showSection('pw-form');
}
});
setTimeout(function(){
if(!ready){
showSection('email-form');
showMsg('This reset link has expired. Enter your email below to get a new reset code.','info');
}
},5000);
}

init();

document.addEventListener('DOMContentLoaded',function(){

$('email-form').addEventListener('submit',async function(e){
e.preventDefault();clearMsg();clearErrs('email-err');
var email=$('email').value.trim();
if(!email){showErr('email-err','Please enter your email');return}
$('email-btn').disabled=true;$('email-btn').textContent='Sending...';
try{
var res=await sb.auth.resetPasswordForEmail(email,{redirectTo:'https://ezrasnashim.app/reset-password'});
if(res.error)throw res.error;
userEmail=email;
$('sent-email').textContent=email;
showSection('code-form');
clearMsg();
}catch(e){
showMsg(e.message||'Failed to send reset code. Please try again.','error');
}
$('email-btn').disabled=false;$('email-btn').textContent='Send Reset Code';
});

$('resend-btn').addEventListener('click',async function(){
clearMsg();
$('resend-btn').disabled=true;$('resend-btn').textContent='Sending...';
try{
var res=await sb.auth.resetPasswordForEmail(userEmail,{redirectTo:'https://ezrasnashim.app/reset-password'});
if(res.error)throw res.error;
showMsg('A new code has been sent to your email.','success');
}catch(e){
showMsg(e.message||'Failed to resend code.','error');
}
$('resend-btn').disabled=false;$('resend-btn').textContent="Didn't receive it? Send again";
});

$('code-form').addEventListener('submit',async function(e){
e.preventDefault();clearMsg();clearErrs('code-err','code-pw-err','code-cpw-err');
var code=$('code').value.trim();
var pw=$('code-pw').value;
var cpw=$('code-cpw').value;
var valid=true;
if(!code||code.length!==6){showErr('code-err','Please enter the 6-digit code');valid=false}
if(pw.length<6){showErr('code-pw-err','Password must be at least 6 characters');valid=false}
if(pw!==cpw){showErr('code-cpw-err','Passwords do not match');valid=false}
if(!valid)return;
$('code-btn').disabled=true;$('code-btn').textContent='Resetting...';
try{
var r1=await sb.auth.verifyOtp({email:userEmail,token:code,type:'recovery'});
if(r1.error)throw r1.error;
var r2=await sb.auth.updateUser({password:pw});
if(r2.error)throw r2.error;
hideAll();
showMsg('Your password has been updated! You can now sign in with your new password.','success');
}catch(e){
showMsg(e.message||'Invalid code or failed to update password. Please try again.','error');
$('code-btn').disabled=false;$('code-btn').textContent='Reset Password';
}
});

$('pw-form').addEventListener('submit',async function(e){
e.preventDefault();clearMsg();clearErrs('pw-err','cpw-err');
var valid=true;
if($('pw').value.length<6){showErr('pw-err','Password must be at least 6 characters');valid=false}
if($('pw').value!==$('cpw').value){showErr('cpw-err','Passwords do not match');valid=false}
if(!valid)return;
$('pw-btn').disabled=true;$('pw-btn').textContent='Updating...';
try{
var res=await sb.auth.updateUser({password:$('pw').value});
if(res.error)throw res.error;
hideAll();
showMsg('Your password has been updated! You can now sign in with your new password.','success');
}catch(e){
showMsg(e.message||'Failed to update password. Please try again.','error');
$('pw-btn').disabled=false;$('pw-btn').textContent='Update Password';
}
});

});
</script>
</body>
</html>