Goal: On the Tzedaka page there are 4 buttons. Each one should count as a “Tzedaka act” (a mitzvah) and update analytics. Three of them also have a money amount that must be tracked. After a successful action, only that specific button turns green.

Buttons:

Gave Tzedaka Elsewhere (no money)

Donate to Active Campaign (money)

Put a Coin in Tzedaka (money)

Sponsor a Day (money + extra fields from modal: “Sponsored by”, “In honor of”, “Message”)

What to do:

UI behavior

When a button completes successfully, turn only that button green and disable it for the current session/day (whatever the app already uses for “done today”).

Do not turn the other buttons green.

Show a short success toast.

Stripe wiring (for the 3 money buttons)

Use the existing Stripe Checkout flow.

For each money button, pass metadata.type so we know which it is:

type = "active_campaign"

type = "put_a_coin"

type = "sponsor_a_day"

For Sponsor a Day, also pass in metadata from the modal:

sponsor_name, in_honor_of, message

On success, do not trust the client. Use the returned session_id to fetch the Checkout Session server-side and verify the payment.

Make sure success/cancel URLs route back correctly to the Tzedaka page.

No-money button (“Gave Elsewhere”)

No Stripe. On click → confirm → call backend to record a tzedaka act with amount = 0 and type = "gave_elsewhere".

Supabase data to save (server-side)

Table: donations

id (uuid), user_id, type (enum: active_campaign | put_a_coin | sponsor_a_day | gave_elsewhere)

amount (number), currency (string), status (succeeded/failed/pending)

sponsor_name (nullable), in_honor_of (nullable), message (nullable)

campaign_id (nullable, for active campaign if you track one), created_at

stripe_session_id (nullable), stripe_payment_intent (nullable), metadata (jsonb)

Table: acts

Record one row per successful Tzedaka act: id, user_id, category = "tzedaka", subtype (same as type above), amount (0 if “gave_elsewhere”), created_at

If you already have these tables, just insert/update accordingly.

Stripe webhooks (server-side)

Handle checkout.session.completed and/or payment_intent.succeeded.

Verify signature.

Upsert into donations with status = "succeeded", set amount, currency, type, and extra fields from metadata.

Insert a matching row in acts (one per successful donation).

Return idempotent results (use stripe_session_id or payment_intent to avoid duplicates).

Stats & analytics updates

Donation stats:

Every successful action increases the Acts of Tzedaka count by +1.

If it involved money (3 buttons), add the amount to:

Money Raised (global total)

The corresponding bucket:

Active Campaign total

Put a Coin total

Sponsor a Day total

Gave Elsewhere: adds +1 act only; no money added.

Feature usage / analytics dashboard:

Count each completed action as:

mitzvah += 1

feature_usage["tzedaka"] += 1

Also track per-button usage (e.g., feature_usage["tzedaka_active_campaign"] += 1, etc.)

These updates should happen after server-side verification (webhook or post-verify endpoint), not on client click.

Page refresh state

After a successful completion, refetch the user’s daily status so the just-completed button shows green. Make this resilient to refresh/reopen.

Edge cases

Double-clicks or retries → make inserts idempotent (keyed by stripe_session_id or payment_intent).

If a Stripe payment fails or is canceled, do not mark the act or update money totals; do not turn the button green.

Validate Sponsor-a-Day modal fields before creating the Checkout Session.

Testing checklist

“Gave Elsewhere” marks an act, turns that button green, updates analytics, no money added.

Each of the 3 money buttons creates a verified donation, adds +1 act, increases “Money Raised” by the amount, updates the correct bucket, turns only that button green.

Webhook receives events once, creates one donation row, one act row, and is idempotent.

Analytics dashboard shows:

Total mitzvos increased by each action.

Feature usage: “Tzedaka” increased, plus the right per-button usage.

Financial Impact: all 3 money actions counted as donations and included in totals; “Gave Elsewhere” excluded from money totals but included in acts.

Refreshing the page keeps the button state correct for the day.

Definition of done

All four buttons work end-to-end.

Correct data is saved in Supabase.

Webhooks verified and idempotent.

Analytics and Financial Impact reflect the rules above.

Only the completed button turns green.

No TypeScript errors; no console errors.

Please implement or update any missing server endpoints, Supabase RPCs, and webhook handlers to meet these rules. Keep code clean, typed, and with clear comments.